<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Калькулятор γ (метод Клемана–Дезорма)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #999; padding: 6px; text-align: center; }
    th { background: #eee; }
    .actions button { margin: 0 2px; }
    .footer { margin-top: 20px; font-size: 0.9em; color: #444; }
  </style>
</head>
<body>
  <h1>Калькулятор γ (метод Клемана–Дезорма)</h1>
  <p>Введи виміряні значення h₁ і h₂ (мм). Дані зберігаються в браузері. Додаток автоматично рахує γ = h₁ / (h₁ - h₂), абсолютну похибку Δγ, а Δγ% обчислюється як (сер.Δγ / сер.γ) · 100%.</p>

  <table id="dataTable">
    <thead>
      <tr>
        <th>#</th>
        <th>h₁ (мм)</th>
        <th>h₂ (мм)</th>
        <th>γ</th>
        <th>Δγ</th>
        <th>Δγ, %</th>
        <th>Дії</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
    <tfoot>
      <tr style="background:#ddd; font-weight:bold;">
        <td>Сер.</td>
        <td id="avgH1"></td>
        <td id="avgH2"></td>
        <td id="avgGamma"></td>
        <td id="avgDelta"></td>
        <td id="avgDeltaPerc"></td>
        <td>—</td>
      </tr>
    </tfoot>
  </table>

  <div style="margin-top:10px;">
    <button onclick="addRow()">Додати рядок</button>
    <button onclick="exportCSV()">Експортувати CSV</button>
    <button onclick="clearTable()">Очистити все</button>
  </div>

  <div class="footer">
    <p><b>Примітки:</b></p>
    <ul>
      <li>Дані автоматично зберігаються у браузері (localStorage).</li>
      <li>Переконайся, що h₁ ≠ h₂ (інакше ділення на нуль).</li>
      <li>Δγ% однакове для всіх рядків і рахується як (сер.Δγ / сер.γ)·100%.</li>
      <li>Рядок «Сер.» автоматично відображає середні значення.</li>
    </ul>
  </div>

<script>
let rows = JSON.parse(localStorage.getItem('gammaRows')||'[]');
if(rows.length===0) rows = [{h1:200,h2:40},{h1:180,h2:30}];

function renderTable(){
  const body = document.getElementById('tableBody');
  body.innerHTML = '';
  let gammas = [];
  let h1s = [], h2s = [];
  rows.forEach((r,i)=>{
    const h1 = parseFloat(r.h1);
    const h2 = parseFloat(r.h2);
    let gamma = NaN;
    if(Number.isFinite(h1)&&Number.isFinite(h2)&&Math.abs(h1-h2)>1e-12){
      gamma = h1/(h1-h2);
      gammas.push(gamma);
      h1s.push(h1);
      h2s.push(h2);
    }
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i+1}</td>
      <td><input type="number" value="${r.h1}" onchange="updateRow(${i},'h1',this.value)"></td>
      <td><input type="number" value="${r.h2}" onchange="updateRow(${i},'h2',this.value)"></td>
      <td>${Number.isFinite(gamma)?gamma.toFixed(6):'—'}</td>
      <td id="dg${i}">—</td>
      <td id="dp${i}">—</td>
      <td class="actions"><button onclick="removeRow(${i})">Видалити</button></td>`;
    body.appendChild(row);
  });

  let avgGamma = gammas.length? gammas.reduce((a,b)=>a+b,0)/gammas.length:NaN;
  let deltas = gammas.map(g=>Math.abs(g-avgGamma));
  let avgDelta = deltas.length? deltas.reduce((a,b)=>a+b,0)/deltas.length:NaN;
  let avgDeltaPerc = (Number.isFinite(avgDelta)&&Number.isFinite(avgGamma))?(avgDelta/avgGamma*100):NaN;
  
  // Заповнення Δγ для кожного рядка
  gammas.forEach((g,i)=>{
    const d = Math.abs(g-avgGamma);
    document.getElementById('dg'+i).innerText = d.toFixed(6);
    document.getElementById('dp'+i).innerText = Number.isFinite(avgDeltaPerc)? avgDeltaPerc.toFixed(3)+'%':'—';
  });

  // Середні
  document.getElementById('avgH1').innerText = h1s.length?(h1s.reduce((a,b)=>a+b,0)/h1s.length).toFixed(2):'—';
  document.getElementById('avgH2').innerText = h2s.length?(h2s.reduce((a,b)=>a+b,0)/h2s.length).toFixed(2):'—';
  document.getElementById('avgGamma').innerText = Number.isFinite(avgGamma)?avgGamma.toFixed(6):'—';
  document.getElementById('avgDelta').innerText = Number.isFinite(avgDelta)?avgDelta.toFixed(6):'—';
  document.getElementById('avgDeltaPerc').innerText = Number.isFinite(avgDeltaPerc)?avgDeltaPerc.toFixed(3)+'%':'—';

  localStorage.setItem('gammaRows',JSON.stringify(rows));
}

function addRow(){rows.push({h1:'',h2:''});renderTable();}
function removeRow(i){rows.splice(i,1);renderTable();}
function updateRow(i,f,v){rows[i][f]=v;renderTable();}
function clearTable(){rows=[];renderTable();}

function exportCSV(){
  let csv = ['#,h1 (mm),h2 (mm),gamma,Δgamma,Δγ (%)'];
  const body = document.getElementById('tableBody').rows;
  for(let i=0;i<body.length;i++){
    const cells = body[i].cells;
    let row=[cells[0].innerText,cells[1].querySelector('input').value,cells[2].querySelector('input').value,cells[3].innerText,cells[4].innerText,cells[5].innerText];
    csv.push(row.join(','));
  }
  const avgRow = ['Сер.',document.getElementById('avgH1').innerText,document.getElementById('avgH2').innerText,document.getElementById('avgGamma').innerText,document.getElementById('avgDelta').innerText,document.getElementById('avgDeltaPerc').innerText];
  csv.push(avgRow.join(','));

  const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='gamma_results.csv';a.click();URL.revokeObjectURL(url);
}

renderTable();
</script>
</body>
</html>
